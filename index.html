<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stable Diffusion 多圖分析與比較工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body class="bg-slate-950 text-slate-200 h-screen flex flex-col overflow-hidden">

    <!-- Top Bar -->
    <header
        class="bg-slate-900 border-b border-slate-800 p-4 flex justify-between items-center shrink-0 z-20 shadow-md">
        <div class="flex items-center gap-3">
            <h1 class="text-xl font-bold text-blue-400">
                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>SD Info Reader
            </h1>
            <span class="text-xs text-slate-500 hidden md:inline">v2.5 Lightbox Fix</span>
        </div>

        <div class="flex gap-2">
            <button onclick="switchView('single')" id="btn-view-single"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white transition-colors">
                <i class="fa-solid fa-image mr-2"></i>單圖分析
            </button>
            <button onclick="switchView('compare')" id="btn-view-compare"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-slate-800 text-slate-400 hover:bg-slate-700 transition-colors">
                <i class="fa-solid fa-table-columns mr-2"></i>差異比較
            </button>
            <button onclick="document.getElementById('file-input').click()"
                class="px-4 py-2 rounded-lg text-sm font-medium bg-green-600 hover:bg-green-700 text-white transition-colors ml-2">
                <i class="fa-solid fa-plus mr-2"></i>新增圖片
            </button>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden relative" id="main-layout">

        <!-- Drop Overlay -->
        <div id="drop-overlay"
            class="absolute inset-0 bg-slate-900/90 z-50 hidden flex flex-col items-center justify-center border-4 border-dashed border-blue-500 m-4 rounded-xl backdrop-blur-sm pointer-events-none">
            <i class="fa-solid fa-cloud-arrow-up text-6xl text-blue-400 mb-4 animate-bounce"></i>
            <h2 class="text-2xl font-bold text-white">放開滑鼠以上傳圖片</h2>
        </div>

        <!-- Sidebar -->
        <aside class="w-24 md:w-32 lg:w-48 bg-slate-900 border-r border-slate-800 flex flex-col shrink-0">
            <div
                class="p-3 border-b border-slate-800 text-xs font-bold text-slate-500 uppercase tracking-wider text-center">
                圖片列表 (<span id="img-count">0</span>)
            </div>
            <div id="gallery-list" class="flex-1 overflow-y-auto p-2 space-y-2">
                <div id="empty-gallery-msg" class="text-center text-slate-600 text-xs py-8 px-2">
                    <i class="fa-regular fa-images text-2xl mb-2"></i>
                    <p>暫無圖片</p>
                </div>
            </div>
            <input type="file" id="file-input" class="hidden" accept="image/png" multiple>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 overflow-hidden bg-slate-950 relative flex flex-col" id="content-area">

            <!-- Welcome -->
            <div id="welcome-screen"
                class="absolute inset-0 overflow-y-auto p-4 md:p-8 flex flex-col items-center justify-center text-center max-w-lg mx-auto fade-in z-0">
                <div class="bg-slate-900 p-8 rounded-2xl border-2 border-dashed border-slate-700 hover:border-blue-500 transition-colors cursor-pointer group w-full"
                    onclick="document.getElementById('file-input').click()">
                    <i
                        class="fa-solid fa-cloud-arrow-up text-5xl text-slate-600 group-hover:text-blue-500 mb-6 transition-colors"></i>
                    <h2 class="text-2xl font-bold text-white mb-2">開始分析</h2>
                    <p class="text-slate-400 mb-6">點擊上傳或直接拖曳圖片到此處<br><span class="text-xs text-slate-500">支援多張 PNG
                            批次上傳</span></p>

                    <div class="relative" onclick="event.stopPropagation()">
                        <div class="flex gap-2">
                            <div class="flex flex-1">
                                <input type="text" id="url-input"
                                    class="w-full bg-slate-800 border border-slate-600 rounded-l-lg px-4 py-2 text-sm focus:outline-none focus:border-blue-500"
                                    placeholder="或輸入圖片網址...">
                                <button onclick="handleUrlInput()"
                                    class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-r-lg text-sm font-medium transition-colors">分析</button>
                            </div>
                            <button onclick="loadDemoImages()"
                                class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg text-sm font-medium transition-colors border border-slate-600">
                                <i class="fa-solid fa-vial mr-1"></i> 預設圖片
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Single View -->
            <div id="single-view" class="hidden absolute inset-0 overflow-y-auto p-4 md:p-8 fade-in z-10">
                <div class="max-w-6xl mx-auto">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <!-- Left: Image -->
                        <div class="lg:col-span-4 space-y-4">
                            <div class="bg-slate-900 rounded-xl p-2 border border-slate-800 shadow-lg sticky top-4">
                                <div class="relative aspect-square bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjgiPgo8cmVjdCB3aWR0aD0iOCIgaGVpZ2h0PSI4IiBmaWxsPSIjMGYxNzJhIi8+CjxyZWN0IHdpZHRoPSI0IiBoZWlnaHQ9IjgiIGZpbGw9IiMxZTI5M2IiLz4KPHJlY3QgeD0iNCIgeT0iNCIgd2lkdGg9IjQiIGhlaWdodD0iNCIgZmlsbD0iIzFlMjkzYiIvPgo8L3N2Zz4=')] rounded-lg overflow-hidden flex items-center justify-center cursor-zoom-in"
                                    onclick="openLightbox(document.getElementById('main-preview').src)">
                                    <img id="main-preview" class="max-w-full max-h-full object-contain" src="" alt="">
                                </div>
                                <div class="mt-3 px-2 pb-1">
                                    <div class="text-xs font-bold text-slate-500 uppercase">檔案名稱</div>
                                    <div id="main-filename" class="text-sm font-mono text-slate-300 break-all"></div>
                                </div>
                            </div>
                        </div>
                        <!-- Right: Info -->
                        <div class="lg:col-span-8 space-y-6">
                            <div
                                class="bg-slate-900 rounded-xl border-l-4 border-green-500 p-5 shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-green-500 font-bold text-xs uppercase tracking-wider mt-1">Prompt
                                    </h3>
                                    <button onclick="copyText('display-prompt')"
                                        class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded transition-colors"
                                        title="複製 Prompt">
                                        <i class="fa-regular fa-copy"></i> 複製
                                    </button>
                                </div>
                                <p id="display-prompt"
                                    class="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap font-light"></p>
                            </div>
                            <div
                                class="bg-slate-900 rounded-xl border-l-4 border-red-500 p-5 shadow-sm hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-red-500 font-bold text-xs uppercase tracking-wider mt-1">Negative
                                        Prompt</h3>
                                    <button onclick="copyText('display-negative')"
                                        class="text-xs bg-slate-800 hover:bg-slate-700 text-slate-300 px-2 py-1 rounded transition-colors"
                                        title="複製 Negative Prompt">
                                        <i class="fa-regular fa-copy"></i> 複製
                                    </button>
                                </div>
                                <p id="display-negative"
                                    class="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap font-light"></p>
                            </div>
                            <div>
                                <h3 class="text-slate-500 font-bold text-xs uppercase tracking-wider mb-3 px-1">生成參數
                                    (點擊卡片複製)</h3>
                                <div id="display-params" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3">
                                </div>
                            </div>
                            <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
                                <div class="flex justify-between items-center p-3 bg-slate-800/50 cursor-pointer hover:bg-slate-800 transition-colors"
                                    onclick="toggleRaw()">
                                    <span class="text-xs font-bold text-slate-400">原始資料 (Raw Data)</span>
                                    <div class="flex items-center gap-2">
                                        <button onclick="event.stopPropagation(); copyText('display-raw')"
                                            class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-2 py-1 rounded transition-colors">
                                            <i class="fa-regular fa-copy"></i> 複製全部
                                        </button>
                                        <i id="raw-arrow" class="fa-solid fa-chevron-down text-slate-500"></i>
                                    </div>
                                </div>
                                <div id="raw-container" class="hidden p-4 bg-slate-950 border-t border-slate-800">
                                    <pre id="display-raw"
                                        class="text-xs font-mono text-green-400 whitespace-pre-wrap break-all max-h-64 overflow-y-auto"></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compare View -->
            <div id="compare-view" class="hidden absolute inset-0 overflow-auto fade-in z-10 p-4 md:p-8">
                <div class="min-w-max">
                    <h2 class="text-xl font-bold text-slate-300 mb-4 px-2">參數差異比對 (僅顯示差異)</h2>
                    <table class="w-full border-separate border-spacing-0 text-left text-sm">
                        <thead id="compare-head" class="text-slate-400 sticky-header"></thead>
                        <tbody id="compare-body" class="divide-y divide-slate-800 bg-slate-900/50"></tbody>
                    </table>
                    <p class="text-center text-slate-500 mt-8 text-sm italic hidden" id="compare-empty-msg">
                        請至少上傳兩張圖片以進行比較。</p>
                    <p class="text-center text-slate-500 mt-8 text-sm italic hidden" id="compare-no-diff-msg">
                        兩張圖片的參數完全相同。</p>
                </div>
            </div>

        </main>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox-modal"
        class="fixed inset-0 bg-black/95 z-50 hidden flex items-center justify-center opacity-0 transition-opacity duration-300 overflow-hidden"
        onwheel="handleLbWheel(event)">

        <!-- Canvas area for dragging and viewing -->
        <div id="lb-canvas" class="relative w-full h-full flex items-center justify-center overflow-hidden"
            onmousedown="handleLbDown(event)" onclick="closeLightbox()">

            <img id="lightbox-image" src="" class="lightbox-img" onclick="event.stopPropagation()"
                ondragstart="return false">
        </div>

        <button
            class="fixed top-5 right-5 text-white/70 hover:text-white text-4xl focus:outline-none z-50 bg-black/50 rounded-full w-12 h-12 flex items-center justify-center backdrop-blur-sm shadow-lg hover:bg-black/80 transition-colors"
            onclick="closeLightbox()">
            <i class="fa-solid fa-xmark"></i>
        </button>

        <!-- Minimap -->
        <div id="lb-minimap-container" class="hidden" onmousedown="handleMinimapDown(event)">
            <img id="lb-minimap-img" src="">
            <div id="lb-minimap-viewport"></div>
        </div>

        <div
            class="fixed bottom-5 left-1/2 -translate-x-1/2 text-center text-slate-300 text-xs pointer-events-none z-50 bg-black/60 px-4 py-2 rounded-full backdrop-blur-md border border-white/10 shadow-xl">
            <span class="opacity-70"><i class="fa-solid fa-mouse mr-1"></i> 滾輪縮放 • <i
                    class="fa-solid fa-up-down-left-right mx-1"></i> 左鍵拖曳 (圖片或地圖) • 點擊背景關閉</span>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast"
        class="fixed bottom-8 left-1/2 transform -translate-x-1/2 translate-y-20 opacity-0 transition-all duration-300 bg-slate-800 border border-slate-700 text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 z-50 pointer-events-none">
        <i class="fa-solid fa-circle-check text-green-500"></i>
        <span id="toast-msg" class="font-medium">已複製</span>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/parser.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/lightbox.js"></script>
    <script src="js/app.js"></script>
</body>

</html>